

1. **Test commands (In order)**

    `DAVIS-test` - contains folders with folders containing sample images from the 480p DAVIS 2016 dataset each:
        -bmx-bumps
        -bmx-trees
    Tree view:
    ```bash
    DAVIS-test/
    │
    ├── JPEGImages/
    │   ├── 480p/
    │   │   ├── bmx-bumps/
    │   │   │   ├── image_0001.jpg
    │   │   │   ├── image_0002.jpg
    │   │   │   └── ...
    │   │   ├── bmx-trees/
    │   │   │   ├── image_0001.jpg
    │   │   │   ├── image_0002.jpg
    │   │   │   └── ...
    │
    ├── Annotations/
    │   ├── 480p/
    │   │   ├── bmx-bumps/
    │   │   │   ├── mask_0001.png
    │   │   │   ├── mask_0002.png
    │   │   │   └── ...
    │   │   ├── bmx-trees/
    │   │   │   ├── mask_0001.png
    │   │   │   ├── mask_0002.png
    │   │   │   └── ...
    ```
    Your folder must include a `.../Annotations/` subdirectory like shown above containing the predetermined masks if you want to use mode 1
        
    ##### Step 1: Crop (crop.py)
    ```bash
    python crop.py DAVIS-test/JPEGImages/480p/bmx-bumps --width 640 --height 480 --mode 0
    ```
    *(no "/", sample is your folder containing raw images)
    `--mode 0` crops the images in `DAVIS-test/JPEGImages/480p/bmx-bump/` and saves in `cropped/bmx-bumps/`
    `--mode 1` (Requires Step 1. mode 0 to be executed first) crops the masks in `DAVIS-test/Annotations/.../bmx-bumps/` and stores it in `dataset/bmx-bumps/masks/` directory, also moves cropped images from `cropped/bmx-bumps/` to `dataset/bmx-bumps/images/`

    ##### Step 2: Mask (masking.py)
    ```bash
    python masking.py cropped/bmx-bumps --mode 0
    ``` 
    *(no "/", sample is your folder containing processed images), saves to /dataset dir,
    `--mode 0` is masking using model mask2former,
    `--mode 1` (Requires Step 1. to be in `--mode 1` as well) requires cropped masks in `DAVIS-test/Annotations/.../bmx-bumps/` generated by Step 1. `--mode 1`

    ##### Step 3: Inpainting (inpaiting.py)
    ```bash
    python inpainting.py dataset/bmx-bumps --model e2fgvi_hq
    ``` 
    `--model` can be: (`--model aotgan`, `--model e2fgvi`, `--model e2fgvi_hq`), saves to /result_inpaint/bmx-bumps/<--model> dir

    ##### Step 4: Relocating (relocating.py)
    ```bash
    python relocating.py result_inpaint/bmx-bumps/e2fgvi_hq --mode 2
    ```
    `--mode` can be integers `--mode 0`, `--mode 1`, `--mode 2` for: (0:'original', 1:'offset', 2:'dynamic'), saves to /result/bmx-bumps/<--model>/<--mode> dir

    ##### Step 5: Encoding (encoding.py)
    ```bash
    python encoding.py result/bmx-bumps/e2fgvi_hq/original
    ```
    *original can be:('original', 'offset', 'dynamic'), saves to /video/bmx-bumps dir

    ##### (OPTIONAL STEP) Convert MP4 to mov
    ```bash
    python mp4tomov.py video videoMOV
    ```

2. **App to Generate masks from SAM2**

    ##### This app generates masks from SAM2, requires manual input
    ```bash
    cp -f "movetosam2-override/SAM2segmenter.py" "sam2/SAM2segmenter.py"
    python sam2/SAM2segmenter.py <video_parent_dir>
    ```
    * where `<video_parent_dir>` contains folders of images each

    ##### Example:
    ```bash
    cp -f "movetosam2-override/SAM2segmenter.py" "sam2/SAM2segmenter.py"
    python sam2/SAM2segmenter.py C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p
    ```

3. **Harmonizer**

    ##### Step 1: Move to harmonizer
    ```bash
    python prepforharmonizer.py x --mode <mode> --width <target_width> --height <target_height>
    ```

    ##### Step 2: Run the harmonizer
    ```bash
    cd Harmonizer
    python -m demo.image_harmonization.run --example-path ..<Path to folder containing mask and composite sub directory>
    cd ..                           
    ```

    ##### Step 3: Run encoding
    ```bash
    python encoding.py <path to harmonized folder> --harmonize
    ```

    ##### Example:
    ```bash
    python prepforharmonizer.py result --mode 2 --width 854 --height 480
    ```

    ```bash
    cd Harmonizer
    python -m demo.image_harmonization.run --example-path ../harmonize/bmx-trees/
    cd ..                           
    ```

    ```bash
    python encodingharmonized.py harmonize/bmx-trees/harmonized
    ```

    ##### (OPTIONAL STEP) Convert MP4 to mov
    ```bash
    python mp4tomov.py videoHarmonized videoHarmonizedMOV
    ```

4. **Master command**

    ##### Usage:
    ```bash
    ./scripts/master.sh <image_parent_directory> <model> <mode> [--no-mask-model] [--harmonize] [--sam2-segment] [--crop_to_width] <ct_width> [--crop_to_height] <ct_height> [--target_width] <t_width> [--target_height] <t_height>
    ```

    ```bash
    <image_parent_directory> -> directory containing folders that would containin sample images each .......DAVIS-test/JPEGImages/480p/**/**(.jpg) eg: 480p/breakdance-flare/00000.jpg, test/surf/00001.jpg
    <model> -> either 'aotgan', 'e2fgvi', 'e2fgvi_hq'
    <mode> -> either 0 for 'original', 1 for 'offset', 2 for 'dynamic'
    <ct_width> -> crop to target width
    <ct_height> -> crop to target height
    <t_width> -> retargetting width
    <t_height> -> retargetting height
    [--no-mask-model] -> use predefined segments in the DAVIS-test\Annotations\480p dir
    [--harmonize] -> harmonize videos and save them in `videoHarmonized` dir
    [--sam2-segment] -> launches the SAM2 app and allow user to define their own segments
    [--crop_to_width] -> specify a required <ct_width> if not, defaults to `640`
    [--crop_to_height] -> specify a required<ct_height> if not, defaults to `480`
    [--target_width] -> specify a required <t_width> if not, defaults to `854`
    [--target_height] -> specify a requirec <t_height> if not, defaults to `480`
    ```
    On completion: video in `video` dir
    
    These are the set of commands to run to generate masks based on the experiments:
        1. mask2former model
        2. predefined segments
        3. SAM2 segmentaion + harmonizer

    ##### Example (in order of 1. 2. 3.):     

    ```bash
    ./scripts/master.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ./scripts/master.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --no-mask-model --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ./scripts/master.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --harmonize --sam2-segment --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ```

5. **Individual workflows for testing**

    ##### Step 1: Crops and launches app for user to apply SAM2 segmentation
    ```bash 
    ./scripts/cropAndSAM.sh <image_parent_directory> --width <ct_width> --height <ct_height>
    ```
    On completion: cropped SAM2 segments in `dataset` dir

    ##### Step 2: Applies mask2former segmentation model for humans unless the following flags are specified
    ```bash 
    ./scripts/bulk.sh <image_parent_directory> <model> <mode> [--inpaint-only] [--relocating-only] [--no-mask-model] [--crop_to_width] <ct_width> [--crop_to_height] <ct_height> [--target_width] <t_width> [--target_height] <t_height>
    ```
    On completion: inpainted frames in `result_inpaint` dir, relocated frames in `result` dir, video in `video` dir
    ```bash
    <image_parent_directory> -> directory containing folders that would containin sample images each .......DAVIS-test/JPEGImages/480p/**/**(.jpg) eg: 480p/breakdance-flare/00000.jpg, test/surf/00001.jpg
    <model> -> either 'aotgan', 'e2fgvi', 'e2fgvi_hq'
    <mode> -> either 0 for 'original', 1 for 'offset', 2 for 'dynamic'
    <ct_width> -> crop to target width
    <ct_height> -> crop to target height
    <t_width> -> retargetting width
    <t_height> -> retargetting height
    [--inpaint-only] -> applies inpainting network ONLY (if you already have the segments in the `dataset` dir)
    [--relocating-only] -> applies relocation algorithm and encoding ONLY (if you already have the `result` dir)
    [--no-mask-model] -> Uses predefined segments
    [--crop_to_width] -> specify a required <ct_width> if not, defaults to `640`
    [--crop_to_height] -> specify a required<ct_height> if not, defaults to `480`
    [--target_width] -> specify a required <t_width> if not, defaults to `854`
    [--target_height] -> specify a requirec <t_height> if not, defaults to `480`
    ```
    ##### Step 3: Create a harmonized video, requires `result` dir containing the relocated frames
    ```bash  
    ./scripts/add_harmonization.sh --width <t_width> --height <t_height> --mode <mode>
    ```

    ##### Alternate: Get videos for diff modes (requires results_inpaint dir with original/offset/dynamic)
    ```bash
    ./scripts/bulk.sh <image_parent_directory>  <model> <mode> --relocating-only [--crop_to_width] <ct_width> [--crop_to_height] <ct_height> [--target_width] <t_width>
    ./scripts/add_harmonization.sh --width <t_width> --height <t_height> --mode <mode>
    ```
    
    On completion: harmonized videos in `videoHarmonized` dir
    *NOTE: If you are using harmonization again where there are other models directory already present in `results`, please delete that model dir as only 1 model dir should be present in results for harmonization eg: `results/e2fgvi_hq` OR `results/aotgan` and also delete the `harmonize` dir

   

    ##### Example:

    ##### SAM2 + Harmonizer:
    ```bash
    ./scripts/cropAndSAM.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p --width 640 --height 480
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --inpaint-only --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ./scripts/add_harmonization.sh --width 854 --height 480 --mode 2
    ```

    ##### Predefined segments:
    ```bash
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --no-mask-model --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ```

    ##### Mask2former segments:
    ```bash
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS-test\JPEGImages\480p e2fgvi_hq 2 --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ```

    ##### Get videos for diff modes (requires results_inpaint dir with original/offset/dynamic):
    ```bash
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p e2fgvi_hq 2 --relocating-only --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ./scripts/add_harmonization.sh --width 854 --height 480 --mode 2
    ```
    6. **Generate properties of the images (number of frames and name)**

    ```bash
    ./scripts/generate_properties.sh <image_parent_directory>
    ```
    - Get masks area (`dataset` dir required)
    ```bash
    python get_masks_metrics.py
    ```
    eg:
    ```bash
    ./scripts/generate_properties.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p
    ```

    7. **Experiments**
    1. Default
    ```bash
    ./scripts/cropAndSAM.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p --width 640 --height 480
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p e2fgvi_hq 2 --inpaint-only --crop_to_width 640 --crop_to_height 480 --target_width 854 --target_height 480
    ./scripts/add_harmonization.sh --width 854 --height 480 --mode 2
    ```
    2. 16:9 to 9:16 (widescreen to portrait) -> some failures for mode 2 (* use mode 1 instead)
    ```bash
    ./scripts/cropAndSAM.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p --width 854 --height 480
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p e2fgvi_hq 1 --inpaint-only --crop_to_width 854 --crop_to_height 480 --target_width 480 --target_height 854
    ./scripts/add_harmonization.sh --width 480 --height 854 --mode 1
    ```

    3. 9:16 to 16:9 (portrait to widescreen) -> irrelevant for davis as crop is too small??? -another dataset may be required
    ```bash
    ./scripts/cropAndSAM.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p --width 480 --height 854
    ./scripts/bulk.sh C:\Users\User\Desktop\FYP\Fix-ORPVR\src\DAVIS\JPEGImages\480p e2fgvi_hq 2 --inpaint-only --crop_to_width 480 --crop_to_height 854 --target_width 854 --target_height 480
    ./scripts/add_harmonization.sh --width 854 --height 480 --mode 2
    ```

    Optional post-processing step:
    ```bash
    python mp4tomov.py video videoMOV       
    python mp4tomov.py videoHarmonized videoHarmonizedMOV 
    python postprocessing.py --name name_run
    ```
    *remember to move the metrics folder in src to somewhere you wanna keep